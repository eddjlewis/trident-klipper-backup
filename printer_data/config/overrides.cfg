[gcode_macro SQUARE_XY_TEST]
description: Move to bed center, then draw 50mm square 10 times
variable_iterations: 10
variable_side: 50.0
variable_speed_mm_s: 600.0
variable_accel: 20000
gcode:
  {% if 'x' not in printer.toolhead.homed_axes or 'y' not in printer.toolhead.homed_axes %}
    {action_raise_error("Home X and Y first")}
  {% endif %}

  {% set cx = (printer.toolhead.axis_minimum.x + printer.toolhead.axis_maximum.x) / 2.0 %}
  {% set cy = (printer.toolhead.axis_minimum.y + printer.toolhead.axis_maximum.y) / 2.0 %}
  {% set half = side / 2.0 %}
  {% set f = speed_mm_s * 60.0 %}
  {% set cfg_v = printer.configfile.settings.printer.max_velocity %}
  {% set cfg_a = printer.configfile.settings.printer.max_accel %}

  SAVE_GCODE_STATE NAME=SQUARE_TEST_STATE

  G90
  SET_VELOCITY_LIMIT VELOCITY={speed_mm_s} ACCEL={accel}
  G1 X{cx} Y{cy} F{f}        ; move to bed center
  G91

  {% for i in range(iterations) %}
    G1 X-{half} Y-{half} F{f}
    G1 X{side}         F{f}
    G1       Y{side}   F{f}
    G1 X-{side}        F{f}
    G1       Y-{side}  F{f}
    G1 X{half} Y{half} F{f}
  {% endfor %}

  G90
  G1 X{cx} Y{cy} F{f}        ; return to bed center
  RESTORE_GCODE_STATE NAME=SQUARE_TEST_STATE
  SET_VELOCITY_LIMIT VELOCITY={cfg_v} ACCEL={cfg_a}



####################################################################################
##                                    Z Tilt Adjustment
####################################################################################
[z_tilt]
##  Use Z_TILT_ADJUST to level the bed.
##  z_positions: Location of toolhead

##--------------------------------------------------------------------
z_positions:
  -50, 18
  150, 348
  350, 18
points:
  50, 50
  150, 250
  250, 50

speed: 300                 # Speed of Z tilt adjustment
horizontal_move_z: 2       # Z axis move speed for adjustments
retries: 10                # Number of retries for adjustment points
retry_tolerance: 0.0075    # Retry tolerance for adjustment accuracy



################################################################################
## XY Safe Homing
################################################################################
[gcode_macro _SAFE_HOME_XY]
description: Safely home X and/or Y axes with proper backoff moves
gcode:
    # Get currently homed axes (string like "xy", "x", "y", or "")
    {% set HA = printer.toolhead.homed_axes %}
    
    # Check if homing both axes (no AXIS parameter or empty AXIS parameter)
    {% set home_both = 'X' not in params.AXIS and 'Y' not in params.AXIS %}
    
    # Determine if Y should be homed:
    # - home_both: homing all axes
    # - 'Y' in params.AXIS: Y explicitly requested
    # - ('X' in params.AXIS and 'y' not in HA): X requested but Y not homed (need Y for safe X homing)
    {% set home_y = home_both or 'Y' in params.AXIS or ('X' in params.AXIS and 'y' not in HA) %}
    
    # Determine if X should be homed:
    # - home_both: homing all axes
    # - 'X' in params.AXIS: X explicitly requested
    {% set home_x = home_both or 'X' in params.AXIS %}

    # HOME Y AXIS
    {% if home_y %}
        # Pause 1 second for motor stabilization
        G4 P1000
        RESPOND PREFIX="[_SAFE_HOME_XY]" MSG="About to call BASE_G28 Y"
        # Home Y axis (moves to Y max endstop) - call BASE to bypass override
        BASE_G28 Y
        RESPOND PREFIX="[_SAFE_HOME_XY]" MSG="BASE_G28 Y completed"
        # Switch to relative positioning
        G91
        # Back off 50mm from endstop to release sensorless homing trigger
        G1 Y-50 F8000
        # Switch back to absolute positioning
        G90
    {% endif %}

    # HOME X AXIS
    {% if home_x %}
        # Safety check: ensure Y position is safe before homing X
        # Note: toolhead position does not update during homing, so check before
        {% if not home_y and printer.toolhead.position.y < 100 %}
            # If Y is less than 100mm and wasn't just homed, move to safe Y position
            # This prevents X homing from occurring at the front of the bed
            G1 Y100 F3000
        {% endif %}

        # Pause 0.7sec second for motor stabilization
        G4 P700
        RESPOND PREFIX="[_SAFE_HOME_XY]" MSG="About to call BASE_G28 X"
        # Home X axis (moves to X max endstop) - call BASE to bypass override
        BASE_G28 X
        RESPOND PREFIX="[_SAFE_HOME_XY]" MSG="BASE_G28 X completed"
        # Switch to relative positioning
        G91
        # Back off 10mm from endstop to release sensorless homing trigger
        G1 X-10 F8000
        # Switch back to absolute positioning
        G90
    {% endif %}
################################################################################
##                              Homing Override
################################################################################
[homing_override]
axes: xyz
rename_existing: BASE_G28
gcode:
    # DEBUG: Show EVERY time override is entered
    RESPOND PREFIX="[OVERRIDE-ENTRY]" MSG="G28 called with params: X={'X' in params} Y={'Y' in params} Z={'Z' in params}"
    
    #===========================================================================
    # SAVE STATE
    #===========================================================================
    # Save current G-code state (position, speeds, coordinate system)
    # Will be restored at end without moving toolhead (MOVE=0)
    SAVE_GCODE_STATE NAME=PRE_HOMING_STATE

    #===========================================================================
    # DETERMINE WHAT TO HOME
    #===========================================================================
    # Get currently homed axes (returns string like "xyz", "xy", "x", etc.)
    {% set HA = printer.toolhead.homed_axes|lower() %}
    
    # Get current toolhead position
    {% set pos = printer.toolhead.position %}
    
    # Determine if this is a full home (G28 with no parameters)
    {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}
    
    # Check if Z homing is requested (either explicitly or via full home)
    {% set home_z = home_all or 'Z' in params %}
    
    # Check if X and/or Y homing is requested
    {% set home_x = 'X' in params or home_all %}
    {% set home_y = 'Y' in params or home_all %}

    # DEBUG: Display homing state at start
    RESPOND PREFIX="[HOMING]" MSG="POS: X={pos.x|round(2)} Y={pos.y|round(2)} Z={pos.z|round(2)}"
    RESPOND PREFIX="[HOMING]" MSG="HA: '{HA}' | Requested: {'X' if home_x else ''}{'Y' if home_y else ''}{'Z' if home_z else ''}"

    #===========================================================================
    # Z SAFETY PREPARATION (if Z not homed yet)
    #===========================================================================
    # If Z is not currently homed, set artificial Z=0 position
    # This allows us to safely lift Z even when position is unknown
    {% if 'z' not in HA %}
        SET_KINEMATIC_POSITION Z=0
    {% endif %}

    # Safety check: if Z position is less than 5mm, lift bed away from nozzle
    # This prevents crashes during XY homing moves
    {% if pos.z < 5 %}
        G91                    # Switch to relative positioning
        G0 Z5 F1200           # Lift Z by 5mm for safety
        M400                  # Wait for move to complete
        G90                   # Switch back to absolute positioning
    {% endif %}

    #===========================================================================
    # HOME X AND Y AXES
    #===========================================================================
    # Case 1: X and/or Y explicitly requested - home them
    {% if home_x or home_y %}
        {% set axis_param = ("X" if home_x else "") + ("Y" if home_y else "") %}
        RESPOND PREFIX="[XY-CASE1]" MSG="Calling _SAFE_HOME_XY AXIS={axis_param}"
        _SAFE_HOME_XY AXIS={axis_param}
        RESPOND PREFIX="[XY-DONE]" MSG="After XY homing: '{printer.toolhead.homed_axes|lower()}'"
    
    # Case 2: Z requested but X or Y not homed - must home XY first for safe Z homing
    {% elif home_z and ('x' not in HA or 'y' not in HA) %}
        RESPOND PREFIX="[XY-CASE2]" MSG="Calling _SAFE_HOME_XY AXIS=XY"
        _SAFE_HOME_XY AXIS=XY
        RESPOND PREFIX="[XY-DONE]" MSG="After XY homing: '{printer.toolhead.homed_axes|lower()}'"
    {% else %}
        RESPOND PREFIX="[XY-SKIP]" MSG="No XY homing needed"
    {% endif %}

    #===========================================================================
    # HOME Z AXIS
    #===========================================================================
    # Z homing can ONLY happen if both X and Y are homed (need known position for center move)
    # Check current homed axes status (after XY homing may have just occurred)
    
    # DEBUG: Show Z homing decision
    {% set current_axes = printer.toolhead.homed_axes|lower() %}
    RESPOND PREFIX="[Z-CHECK]" MSG="home_z={home_z} | current_axes='{current_axes}' | x_homed={'x' in current_axes} | y_homed={'y' in current_axes}"
    
    {% if home_z and 'x' in printer.toolhead.homed_axes|lower() and 'y' in printer.toolhead.homed_axes|lower() %}
        RESPOND PREFIX="[Z-HOMING]" MSG="Conditions met - moving to 150,150 and homing Z"
        # Move to bed center (150, 150) for Z homing with Cartographer probe
        G1 X150 Y150 F15000
        # Home Z axis using Cartographer probe at center position - call BASE to bypass override
        BASE_G28 Z
    {% else %}
        RESPOND PREFIX="[Z-SKIP]" MSG="Z homing skipped - conditions not met"
    {% endif %}

    #===========================================================================
    # RESTORE STATE
    #===========================================================================
    # Restore saved G-code state without moving toolhead
    # MOVE=0 prevents position confusion after homing individual axes
    RESTORE_GCODE_STATE NAME=PRE_HOMING_STATE MOVE=0

    #===========================================================================
    # BEHAVIOR TABLE
    #===========================================================================
    # Command    | What Happens
    # -----------|----------------------------------------------------------
    # G28        | _SAFE_HOME_XY(XY) → Move to 150,150 → G28 Z
    #            | (Full home: always homes all three axes)
    # -----------|----------------------------------------------------------
    # G28 X      | _SAFE_HOME_XY(X)
    #            | Note: _SAFE_HOME_XY will home Y first if Y not already homed
    # -----------|----------------------------------------------------------
    # G28 Y      | _SAFE_HOME_XY(Y)
    #            | (Y only, no automatic X homing)
    # -----------|----------------------------------------------------------
    # G28 Z      | _SAFE_HOME_XY(XY) if needed → Move to 150,150 → G28 Z
    #            | (Z requires X&Y to be homed first for center position)
    # -----------|----------------------------------------------------------
    # G28 XY     | _SAFE_HOME_XY(XY)
    #            | (Homes both X and Y, no Z)
    # -----------|----------------------------------------------------------
    # G28 XZ     | _SAFE_HOME_XY(X) → Move to 150,150 → G28 Z
    #            | Note: _SAFE_HOME_XY will home Y first if Y not already homed
    # -----------|----------------------------------------------------------
    # G28 YZ     | _SAFE_HOME_XY(Y) then _SAFE_HOME_XY(X) if needed → Move to 150,150 → G28 Z
    #            | (Y homes first, then X if not homed, then Z)
    # -----------|----------------------------------------------------------
    # G28 XYZ    | _SAFE_HOME_XY(XY) → Move to 150,150 → G28 Z
    #            | (Same as G28 - full home)
    #===========================================================================


#-------------------------------------------------------------------------------
[gcode_macro Z_TILT_ADJUST]     # IDM/Cartographer optimized 3Z leveling macro
rename_existing: _Z_TILT_ADJUST
gcode:
    SAVE_GCODE_STATE NAME=STATE_Z_TILT         # Save current state for Z tilt adjustment
    BED_MESH_CLEAR                             # Clear bed mesh
    {% if not printer.z_tilt.applied %}
      _Z_TILT_ADJUST horizontal_move_z=10 retry_tolerance=1   # Adjust Z tilt with higher tolerance initially
    {% endif %}
    _Z_TILT_ADJUST horizontal_move_z=2          # Fine-tune Z tilt adjustment
    RESTORE_GCODE_STATE NAME=STATE_Z_TILT       # Restore saved state after adjustment
    CENTER


################################################################################
##                  Bed Leveling and Height Calibration Macro
################################################################################
[gcode_macro G32]
gcode:
    BED_MESH_CLEAR               # Clear bed mesh
    G28                          # Home all axes
    Z_TILT_ADJUST                # Perform gantry leveling
    G28 Z                        # Home Z axes again
    G0 X150 Y150 Z30 F3600       # Fast move to X150 Y150 Z30 at 3600 mm/min
