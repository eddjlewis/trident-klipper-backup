[gcode_macro SQUARE_XY_TEST]
description: Move to bed center, then draw 50mm square 10 times
variable_iterations: 10
variable_side: 50.0
variable_speed_mm_s: 600.0
variable_accel: 20000
gcode:
  {% if 'x' not in printer.toolhead.homed_axes or 'y' not in printer.toolhead.homed_axes %}
    {action_raise_error("Home X and Y first")}
  {% endif %}

  {% set cx = (printer.toolhead.axis_minimum.x + printer.toolhead.axis_maximum.x) / 2.0 %}
  {% set cy = (printer.toolhead.axis_minimum.y + printer.toolhead.axis_maximum.y) / 2.0 %}
  {% set half = side / 2.0 %}
  {% set f = speed_mm_s * 60.0 %}
  {% set cfg_v = printer.configfile.settings.printer.max_velocity %}
  {% set cfg_a = printer.configfile.settings.printer.max_accel %}

  SAVE_GCODE_STATE NAME=SQUARE_TEST_STATE

  G90
  SET_VELOCITY_LIMIT VELOCITY={speed_mm_s} ACCEL={accel}
  G1 X{cx} Y{cy} F{f}        ; move to bed center
  G91

  {% for i in range(iterations) %}
    G1 X-{half} Y-{half} F{f}
    G1 X{side}         F{f}
    G1       Y{side}   F{f}
    G1 X-{side}        F{f}
    G1       Y-{side}  F{f}
    G1 X{half} Y{half} F{f}
  {% endfor %}

  G90
  G1 X{cx} Y{cy} F{f}        ; return to bed center
  RESTORE_GCODE_STATE NAME=SQUARE_TEST_STATE
  SET_VELOCITY_LIMIT VELOCITY={cfg_v} ACCEL={cfg_a}



####################################################################################
##                                    Z Tilt Adjustment
####################################################################################
[z_tilt]
##  Use Z_TILT_ADJUST to level the bed.
##  z_positions: Location of toolhead

##--------------------------------------------------------------------
z_positions:
  -50, 18
  150, 348
  350, 18
points:
  50, 50
  150, 250
  250, 50

speed: 300                 # Speed of Z tilt adjustment
horizontal_move_z: 2       # Z axis move speed for adjustments
retries: 10                # Number of retries for adjustment points
retry_tolerance: 0.0075    # Retry tolerance for adjustment accuracy



################################################################################
##                              TEST MACRO
################################################################################
[gcode_macro CHECK_HOMED]
description: Show current homed axes status
gcode:
    RESPOND PREFIX="[HOMED_AXES]" MSG="'{printer.toolhead.homed_axes}'"

################################################################################
##                              Homing Override
################################################################################
[homing_override]
axes: xyz
gcode:
    
    #===========================================================================
    # SAVE STATE
    #===========================================================================
    # Save current G-code state (position, speeds, coordinate system)
    # Will be restored at end without moving toolhead (MOVE=0)
    SAVE_GCODE_STATE NAME=PRE_HOMING_STATE

    # Show additional useful info
    {% if printer.gcode_move.absolute_coordinates %}
        RESPOND PREFIX="[MODE]" MSG="Positioning: ABSOLUTE (G90)"
    {% else %}
        RESPOND PREFIX="[MODE]" MSG="Positioning: RELATIVE (G91)"
    {% endif %}

    #===========================================================================
    # DETERMINE WHAT TO HOME
    #===========================================================================
    # Get currently homed axes (returns string like "XYZ", "XY", "X", etc.)
    {% set HA = printer.toolhead.homed_axes|upper() %}
    
    # Get current toolhead position
    {% set pos = printer.toolhead.position %}
    
    # Determine if this is a full home (G28 with no parameters)
    {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}
    
    # Determine which axes are requested to be homed
    {% set home_x = 'X' in params or home_all %}
    {% set home_y = 'Y' in params or home_all %}
    {% set home_z = 'Z' in params or home_all %}
    
    # DEBUG: Show initial state
    RESPOND PREFIX="[HOMING]" MSG="Requested: {'X' if home_x else ''}{'Y' if home_y else ''}{'Z' if home_z else ''} | Currently homed: '{HA}'"
    
    #===========================================================================
    # Z SAFETY PREPARATION (if Z not homed yet)
    #===========================================================================
    # If Z is not currently homed, force Z homing and set artificial Z=0 position
    # This allows us to safely lift Z even when position is unknown
    {% set force_z = False %}
    {% if 'Z' not in HA %}
        {% set force_z = True %}
        RESPOND PREFIX="[FORCE_Z]" MSG="Z not homed - will force Z homing for safety"
        SET_KINEMATIC_POSITION Z=0
    {% endif %}

    # Safety check: if Z position is less than 5mm, lift bed away from nozzle
    # This prevents crashes during XY homing moves
    {% if pos.z < 5 %}
        RESPOND PREFIX="[Z Move]" MSG="Moving Z down 5mm for safety"
        G91                    # Switch to relative positioning
        G0 Z5 F1200           # Lift Z by 5mm for safety
        M400                  # Wait for move to complete
        G90                   # Switch back to absolute positioning
    {% endif %}

    {% set force_z = True %}
        SET_KINEMATIC_POSITION CLEAR=Z


    POSITION_STATUS
    #===========================================================================
    # HOME Y AXIS
    #===========================================================================
    # Y must be homed in these cases:
    # 1. Y homing explicitly requested (home_y=True)
    # 2. X homing requested but Y not yet homed (X needs Y for safe positioning)
    # 3. Z homing requested but Y not yet homed (Z needs XY for center position)
    {% set y_was_homed = home_y or (home_x and 'Y' not in HA) or (home_z and 'Y' not in HA) %}
    {% if y_was_homed %}
        RESPOND PREFIX="[HOME_Y]" MSG="Homing Y axis"
        # Pause 0.7 second for motor stabilization before homing
        G4 P700
        # Home Y axis (moves to Y max endstop)
        G28 Y
        # Switch to relative positioning for backoff move
        G91
        # Back off 50mm from endstop to release sensorless homing trigger
        G1 Y-50 F8000
        # Switch back to absolute positioning
        G90
    {% endif %}

    #===========================================================================
    # HOME X AXIS
    #===========================================================================
    # X must be homed in these cases:
    # 1. X homing explicitly requested (home_x=True)
    # 2. Z homing requested but X not yet homed (Z needs XY for center position)
    {% if home_x or (home_z and 'X' not in HA) %}

        RESPOND PREFIX="[HOME_X]" MSG="Homing X axis"
        # Safety check: ensure Y position is safe before homing X
        # Only check if Y wasn't just homed (would be at ~250 after backoff)
        # If Y is less than 100mm, move to safe Y position
        # This prevents X homing from occurring at the front of the bed
        {% if not y_was_homed and printer.toolhead.position.y < 100 %}
            RESPOND PREFIX="[SAFETY MOVE]" MSG="Moving Y+100"
            G1 Y100 F3000
        {% endif %}
        
        # Pause 0.7 seconds for motor stabilization before homing
        G4 P700
        # Home X axis (moves to X max endstop)
        G28 X
        # Switch to relative positioning for backoff move
        G91
        # Back off 10mm from endstop to release sensorless homing trigger
        G1 X-10 F8000
        # Switch back to absolute positioning
        G90
    {% endif %}

    #===========================================================================
    # HOME Z AXIS
    #===========================================================================
    # Z must be homed in these cases:
    # 1. Z homing explicitly requested (home_z=True)
    # 2. Z was not homed at start (force_z=True for safety)
    # Note: At this point, X and Y are guaranteed to be homed (from logic above)
    {% if home_z or force_z %}
        RESPOND PREFIX="[HOME_Z]" MSG="Homing Z axis (home_z={home_z}, force_z={force_z})"
        
        #Force absolute positioning, just in case only Z is being homed
        G90
        # Move to bed center (150, 150) for Z homing with Cartographer probe
        G1 X150 Y150 F9000
        # Home Z axis using Cartographer probe at center position
        G28 Z
    {% else %}
        RESPOND PREFIX="[SKIP_Z]" MSG="Z homing skipped"
    {% endif %}

    #===========================================================================
    # RESTORE STATE
    #===========================================================================
    # Restore saved G-code state without moving toolhead
    # MOVE=0 prevents position confusion after homing
    RESTORE_GCODE_STATE NAME=PRE_HOMING_STATE
  
    #===========================================================================
    # BEHAVIOR TABLE
    #===========================================================================
    # Command    | What Happens
    # -----------|----------------------------------------------------------
    # G28        | Home Y → Home X → Move to 150,150 → Home Z
    #            | (Full home: always homes all three axes)
    # -----------|----------------------------------------------------------
    # G28 X      | IF Z NOT HOMED (force_z):
    #            |   Home Y → Home X → Move to 150,150 → Home Z (SAFETY)
    #            | IF Z ALREADY HOMED:
    #            |   Home Y (if not homed) → Home X
    #            | (Y is homed first automatically for safe X homing)
    # -----------|----------------------------------------------------------
    # G28 Y      | IF Z NOT HOMED (force_z):
    #            |   Home Y → Move to 150,150 → Home Z (SAFETY)
    #            | IF Z ALREADY HOMED:
    #            |   Home Y only
    # -----------|----------------------------------------------------------
    # G28 Z      | Home Y (if needed) → Home X (if needed) → Move to 150,150 → Home Z
    #            | (Z requires X&Y to be homed first for center position)
    # -----------|----------------------------------------------------------
    # G28 XY     | IF Z NOT HOMED (force_z):
    #            |   Home Y → Home X → Move to 150,150 → Home Z (SAFETY)
    #            | IF Z ALREADY HOMED:
    #            |   Home Y → Home X
    # -----------|----------------------------------------------------------
    # G28 XZ     | Home Y (if not homed) → Home X → Move to 150,150 → Home Z
    # -----------|----------------------------------------------------------
    # G28 YZ     | Home Y → Home X (if not homed) → Move to 150,150 → Home Z
    # -----------|----------------------------------------------------------
    # G28 XYZ    | Home Y → Home X → Move to 150,150 → Home Z
    #            | (Same as G28 - full home)
    # -----------|----------------------------------------------------------
    # SAFETY     | If Z is not homed at the start of ANY homing command,
    # FEATURE    | force_z=True will ensure Z is homed before completion.
    #            | This prevents moving with unknown Z position (crash risk).
    #===========================================================================

    #===========================================================================
    # BEHAVIOR TABLE
    #===========================================================================
    # Command    | What Happens
    # -----------|----------------------------------------------------------
    # G28        | _SAFE_HOME_XY(XY) → Move to 150,150 → G28 Z
    #            | (Full home: always homes all three axes)
    # -----------|----------------------------------------------------------
    # G28 X      | _SAFE_HOME_XY(X)
    #            | Note: _SAFE_HOME_XY will home Y first if Y not already homed
    # -----------|----------------------------------------------------------
    # G28 Y      | _SAFE_HOME_XY(Y)
    #            | (Y only, no automatic X homing)
    # -----------|----------------------------------------------------------
    # G28 Z      | _SAFE_HOME_XY(XY) if needed → Move to 150,150 → G28 Z
    #            | (Z requires X&Y to be homed first for center position)
    # -----------|----------------------------------------------------------
    # G28 XY     | _SAFE_HOME_XY(XY)
    #            | (Homes both X and Y, no Z)
    # -----------|----------------------------------------------------------
    # G28 XZ     | _SAFE_HOME_XY(X) → Move to 150,150 → G28 Z
    #            | Note: _SAFE_HOME_XY will home Y first if Y not already homed
    # -----------|----------------------------------------------------------
    # G28 YZ     | _SAFE_HOME_XY(Y) then _SAFE_HOME_XY(X) if needed → Move to 150,150 → G28 Z
    #            | (Y homes first, then X if not homed, then Z)
    # -----------|----------------------------------------------------------
    # G28 XYZ    | _SAFE_HOME_XY(XY) → Move to 150,150 → G28 Z
    #            | (Same as G28 - full home)
    #===========================================================================


#-------------------------------------------------------------------------------
[gcode_macro Z_TILT_ADJUST]     # IDM/Cartographer optimized 3Z leveling macro
rename_existing: _Z_TILT_ADJUST
gcode:
    SAVE_GCODE_STATE NAME=STATE_Z_TILT         # Save current state for Z tilt adjustment
    BED_MESH_CLEAR                             # Clear bed mesh
    {% if not printer.z_tilt.applied %}
      _Z_TILT_ADJUST horizontal_move_z=10 retry_tolerance=1   # Adjust Z tilt with higher tolerance initially
    {% endif %}
    _Z_TILT_ADJUST horizontal_move_z=2          # Fine-tune Z tilt adjustment
    RESTORE_GCODE_STATE NAME=STATE_Z_TILT       # Restore saved state after adjustment
    CENTER


################################################################################
##                  Bed Leveling and Height Calibration Macro
################################################################################
[gcode_macro G32]
gcode:
    BED_MESH_CLEAR               # Clear bed mesh
    G28                          # Home all axes
    Z_TILT_ADJUST                # Perform gantry leveling
    G28 Z                        # Home Z axes again
    G0 X150 Y150 Z30 F3600       # Fast move to X150 Y150 Z30 at 3600 mm/min
