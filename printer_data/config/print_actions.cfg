
################################################################################
##                            Position Status
################################################################################
[gcode_macro POSITION_STATUS]
description: Display current toolhead position, homing state, and Z offset
gcode:
    {% set pos = printer.toolhead.position %}
    {% set homed = printer.toolhead.homed_axes %}
    {% set gcode_offset = printer.gcode_move.homing_origin %}
    
    # Build status message
    RESPOND PREFIX="[POSITION_STATUS]" MSG="================================"
    RESPOND PREFIX="[POSITION]" MSG="X: {pos.x|round(3)} Y: {pos.y|round(3)} Z: {pos.z|round(3)}"
    RESPOND PREFIX="[HOMING]" MSG="Homed Axes: {'X' if 'x' in homed else '-'}{'Y' if 'y' in homed else '-'}{'Z' if 'z' in homed else '-'}"
    RESPOND PREFIX="[Z_OFFSET]" MSG="Current: {gcode_offset.z|round(3)}mm"
    
    # Show additional useful info
    {% if printer.gcode_move.absolute_coordinates %}
        RESPOND PREFIX="[MODE]" MSG="Positioning: ABSOLUTE (G90)"
    {% else %}
        RESPOND PREFIX="[MODE]" MSG="Positioning: RELATIVE (G91)"
    {% endif %}
    
    {% if printer.gcode_move.absolute_extrude %}
        RESPOND PREFIX="[MODE]" MSG="Extrusion: ABSOLUTE (M82)"
    {% else %}
        RESPOND PREFIX="[MODE]" MSG="Extrusion: RELATIVE (M83)"
    {% endif %}
    
    RESPOND PREFIX="[POSITION_STATUS]" MSG="================================"



################################################################################
##                                Print Actions
################################################################################

[gcode_macro REPO]
description: Main print start macro with heating, leveling, and mesh
gcode:
    SET_MACRO_TRACE ENABLE=1
    # Clear any existing bed mesh from previous prints
    BED_MESH_CLEAR

   

    # Display status message on screen
    M117 Homing...
    
    # Home all axes (X, Y, Z)
    G28
  

    
    # Move Z up to 30mm to allow heat to spread and prevent nozzle damage
    G1 Z30 F1000
    
    # Display Z-tilt adjustment status
    M117 Adjusting Z Tilt...
    
    # Re-home Z axis to ensure accurate starting position
    G28 Z
    
    # Level the gantry using 3-point Z tilt adjustment
    Z_TILT_ADJUST

    # Perform Cartographer touch probe to calibrate Z offset before mesh
    # IMPORTANT: Nozzle must be at or below 150째C for CARTOGRAPHER_TOUCH
    # Performing touch with COLD nozzle (faster and within spec)
    # Safety check: If nozzle somehow exceeds 150째C, wait for it to cool down
    M117 Cartographer Touch - 150C nozzle...
    CARTOGRAPHER_TOUCH_HOME


#--------------------------------------------------------------------
# Print Start
#--------------------------------------------------------------------
[gcode_macro PRINT_START]
description: Main print start macro with heating, leveling, and mesh
gcode:
    # Clear any existing bed mesh from previous prints
    BED_MESH_CLEAR

    # Extract parameters passed from slicer with default values
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}           # Bed temperature from slicer
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(200)|float %}  # Extruder temperature from slicer
    {% set CHAMBER_TEMP = params.CHAMBER|default(0)|float %}         # Optional chamber temp (0 = disabled)
    {% set SKEW_PROFILE = params.SKEW_PROFILE|default("")|string %}  # Optional skew correction profile name

    # Cancel any existing fume pack stop timer from previous print
    _CANCEL_FUME_PACK_STOP_TIMER

    # Display status message on screen
    M117 Homing...
    
    # Home all axes (X, Y, Z)
    G28
    
    # Check if motor synchronization has been applied; if not, run it
    {% if not printer.motors_sync.applied %}
        M117 Syncing Motors...
        # Turn off part cooling fans to reduce vibrations during motor sync
        M106 S0 # cooling fan
        SET_FAN_SPEED FAN=fan3 SPEED=0
      

    
        # Synchronize motor phases for improved motion quality
        SYNC_MOTORS
    {% endif %}

    # Turn the fume pack exhaust fan on at full speed
    SET_FAN_SPEED FAN=fan3 SPEED=1.0

    # Display heating status
    M117 Heating bed...
    
    # Move Z up to 30mm to allow heat to spread and prevent nozzle damage
    G1 Z30 F1000
    
    # Start heating the bed to target temperature (non-blocking)
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={BED_TEMP}
    
    # Start heating extruder
    M104 S150 ; Heat nozzle to soften filament leftovers
    
    # Wait for bed to reach target temperature
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={BED_TEMP}

    # If chamber temp was specified and is valid, wait for it to reach target
    {% if CHAMBER_TEMP > 0 %}
        {% if CHAMBER_TEMP < BED_TEMP %}
            # Wait for chamber to reach minimum temperature using EBB toolhead thermistor
            TEMPERATURE_WAIT SENSOR="temperature_sensor EBB_NTC" MINIMUM={CHAMBER_TEMP}
        {% else %}
            # Chamber temp cannot exceed bed temp - show error and cancel
            M117 CHAMBER temp cannot be greater than BED temp!
            RESPOND TYPE=error MSG="CHAMBER temp cannot be greater than BED temp!"
            CANCEL_PRINT
        {% endif %}
    {% endif %}

    # Display Z-tilt adjustment status
    M117 Adjusting Z Tilt...
    
    # Re-home Z axis to ensure accurate starting position
    G28 Z
    # nozzle ends up at ~2mm off bed
    
    # Level the gantry using 3-point Z tilt adjustment
    Z_TILT_ADJUST

    # Perform Cartographer touch probe to calibrate Z offset before mesh
    # IMPORTANT: Nozzle must be at or below 150째C for CARTOGRAPHER_TOUCH
    # Performing touch with COLD nozzle (faster and within spec)
    # Safety check: If nozzle somehow exceeds 150째C, wait for it to cool down
    M117 Cartographer Touch - 150C nozzle...
    M109 S150 ; Ensure nozzle is at 150C, in case it was hot when print started.
    CARTOGRAPHER_TOUCH_HOME

    # Create an adaptive bed mesh based on print area
    # This should be done before CARTOGRAPHER_TOUCH for best accuracy
    M117 Bed Meshing...
    BED_MESH_CALIBRATE ADAPTIVE=1 PROFILE="print_mesh"

    # Now heat the nozzle to full printing temperature
    M117 Heating nozzle to {EXTRUDER_TEMP}C...
    

    G90 # Absolute positioning, just in case
    # Move bed down 10mm from nozzle to allow final heating without heat damage
    G1 Z30 F1000
    # Move to front of bed for purge line (X=150, Y=15)
    G0 X150 Y15 F36000
    
    # Set extruder to target printing temperature
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={EXTRUDER_TEMP}
    
    # Wait for extruder to reach target temperature
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={EXTRUDER_TEMP}

    # Load skew correction profile if specified
    # {% if SKEW_PROFILE != "" %}
    #     M117 Loading skew profile: {SKEW_PROFILE}
    #     SKEW_PROFILE LOAD={SKEW_PROFILE}
    # {% endif %}

    # Draw purge line to prime the nozzle
    M117 Purging nozzle...
    DRAW_LINES

    # Clear status message
    M117


#--------------------------------------------------------------------
# Draw Purge Lines
#--------------------------------------------------------------------
[gcode_macro DRAW_LINES]
description: Draw purge lines at front of bed to prime nozzle
gcode:
    # Set to absolute positioning mode
    G90
    
    # Move to start position (X=50, Y=0) at front left of bed
    G1 X50 Y0 F7200
    
    # Lower nozzle to first layer height (0.28mm) BEFORE extruding
    G1 Z0.28 F7200
    
    # Switch extruder to relative mode for extrusion
    M83
    
    # Reset extruder position to zero to start fresh
    G92 E0
    
    # Extrude a small amount to start flow, then draw first line
    # Drawing from X50 to X200 while extruding 15mm
    G1 X200 Y0 Z0.28 F1200 E15
    
    # Move slightly to the side (0.4mm in Y)
    G1 X200 Y0.4 Z0.28 F2400
    
    # Draw second line from X200 back to X55, extruding another 15mm
    G1 X55 Y0.4 Z0.28 F1200 E30
    
    # Reset extruder position to zero
    G92 E0
    
    # Return to absolute positioning mode
    G90


#--------------------------------------------------------------------
# Print End
#--------------------------------------------------------------------
[gcode_macro PRINT_END]
description: Main print end macro - parks toolhead, turns off heaters and fans
gcode:
    # Store reference to toolhead object for easy access
    {% set th = printer.toolhead %}
    
    # Calculate a safe position 20mm away from current position in X and Y
    # If less than 20mm from edge, move inward instead of outward
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    
    # Calculate safe Z position: current + 5mm, or max Z (whichever is lower)
    {% set z_safe = [th.position.z + 5, th.axis_maximum.z]|min %}

    # Clear any active skew correction profile
    # SET_SKEW CLEAR=1

    # Save current G-code state (position, speeds, etc.) for later restoration
    SAVE_GCODE_STATE NAME=STATE_PRINT_END

    # Wait for all buffered moves to complete before proceeding
    M400
    
    # Reset extruder position to zero for relative moves
    G92 E0
    
    # Retract filament 4mm at 3600mm/min to prevent oozing
    G1 E-4.0 F3600

    # Turn off all heaters (bed and extruder)
    TURN_OFF_HEATERS

    # Switch to absolute positioning mode
    G90
    
    # Move to safe position to remove any stringing from the print
    G0 X{x_safe} Y{y_safe} Z{z_safe} F7200

    # Calculate final park position with larger Z lift if possible
    # Lift bed by 45mm or to max Z (whichever is lower)
    {% set z_park = [th.position.z + 45, th.axis_maximum.z]|min %}

    # Park toolhead at center X, rear Y (20mm from max), raised Z position
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 20} Z{z_park} F3600
    
    # Turn off part cooling fans (fan0 = 5015 blower, fan2 = 12032 auxiliary)
    SET_FAN_SPEED FAN=fan0 SPEED=0
    # SET_FAN_SPEED FAN=fan2 SPEED=0  # Commented out - fan2 not configured

    # Clear the bed mesh (will be recreated on next print)
    BED_MESH_CLEAR

    # Disable all stepper motors to allow manual movement
    M84

    # Start fume pack stop timer - will turn off fume pack after 10 minutes
    _START_FUME_PACK_STOP_TIMER TIME=600

    # Restore the saved G-code state without moving the toolhead
    # MOVE=0 prevents any unintended toolhead movement during state restoration
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END MOVE=0


#--------------------------------------------------------------------
# NOTE: PAUSE, RESUME, and CANCEL_PRINT are handled by FLAP
# (flap_main.cfg), which is included after this file.
# If you need to modify pause/resume/cancel behavior, edit FLAP config.
#--------------------------------------------------------------------


#--------------------------------------------------------------------
# Cancel
#--------------------------------------------------------------------
[gcode_macro CANCEL_PRINT]
# Defines a G-code macro to cancel the actual running print
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
variable_park: True
gcode:
    SET_SKEW CLEAR=1
    _TOOLHEAD_PARK_PAUSE_CANCEL               # Call _TOOLHEAD_PARK_PAUSE_CANCEL macro
    TURN_OFF_HEATERS                          # Turn off all heaters

    # Start Fume Pack Stop Timer - 10min
    _START_FUME_PACK_STOP_TIMER TIME=600

    CANCEL_PRINT_BASE                         # Call CANCEL_PRINT_BASE to cancel print

#--------------------------------------------------------------------
# NOTE: PAUSE, RESUME, and CANCEL_PRINT are handled by FLAP
# (flap_main.cfg), which is included after this file.
# If you need to modify pause/resume/cancel behavior, edit FLAP config.
#--------------------------------------------------------------------

